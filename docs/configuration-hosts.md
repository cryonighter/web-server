# Конфигурация хостов веб-сервера

Конфигурация хостов веб-сервера хранится в XML-файлах.
По умолчанию конфигурационные файлы ищутся в директории `./config/hosts/`.
Все найденные XML-файлы будут обработаны как файлы конфигурации хостов.

## Примеры конфигураций

### Базовая конфигурация статического сайта

```xml
<?xml version="1.0" encoding="UTF-8" ?>
<config name="static-site">
    <host>example.com</host>
    <webroot>./public</webroot>
    <indexFile>index.html</indexFile>
</config>
```

### Конфигурация с проксированием API редиректами

```xml
<?xml version="1.0" encoding="UTF-8" ?>
<config name="app-with-api">
    <webroot>./dist</webroot>
    <indexFile>index.html</indexFile>

    <host>example.com</host>
    <host>www.example.com</host>

    <path name="api" regexp="^/api">
        <handler type="forward" to="http://localhost:3000" />
    </path>

   <path name="old-blog" regexp="^/blog">
      <handler type="redirect" to="/news" code="301" />
   </path>

   <handler type="file" />
</config>
```

## Структура конфигурационных файлов

### Элемент `<config>`

Корневой элемент, с которого начинается конфигурация хоста.
```xml
<config name="static-site"></config>
```

**Атрибуты:**

| Атрибут | Обязательный | Описание                                                |
|---------|--------------|---------------------------------------------------------|
| `name`  | Нет          | Уникальное имя конфигурации (для логирования и отладки) |
| `port`  | Да           | Порт, на которому прослугивается данныя конфигурация    |

## Основные директивы `<config>`

### Элемент `<host>`

Указывает имя хоста, для которого применяется конфигурация.
Можно указать хостов — описанные директывы будут применены ко всем.

```xml
<host>example.com</host>
<host>example.com:80</host>
<host>www.example.com</host>
```

**По умолчанию:** конфигурация будет применяться ко всем хостам, ссылающимся на IP адрес и порт сервера.

### Элемент `<webroot>`

Определяет корневую директорию для обслуживания статических файлов.
Может быть относительным (от директории запуска) или абсолютным.
Может быть переопределен внутри отдельных `<path>` секций.

```xml
<webroot>/var/www/html</webroot>
```

**По умолчанию:** `./webroot`

### Элемент `<indexFile>`

Указывает имя индексного файла, который будет возвращаться при запросе к директории.
Можно указать несколько таких директив — сервер будет проверять их по порядку и вернет клиенту первый найденный файл.

```xml
<indexFile>index.html</indexFile>
<indexFile>index.php</indexFile>
```

**По умолчанию:** `index.html, index.htm`

### Элемент `<tls>`

Содержит настройки TLS для безопасного соединения с клиентами по протоколу HTTPS.
Распологается внутри корневой дерективы `<config>` и не может быть переопределен в `<path>`.

```xml
<tls>
   <certificate>./cert/server.crt</certificate>
   <privateKey>./cert/server.key</privateKey>
</tls>
```

**По умолчанию:** отсутствует.

## Элемент `<path>` - маршрутизация запросов

Элемент `<path>` определяет правила обработки запросов на основе URL, метода и протокола.
Элементы `<path>` могут быть вложенными друг в друга, вложенные элементы наследуют все
директивы корневых элементов `<path>` и `<config>`, и могут и переопределить их.

```xml
<path name="api" regexp="^/api/" method="GET">
    <handler type="forward" to="http://localhost:3000" />
</path>
```

### Атрибуты `<path>`

| Атрибут    | Обязательный | Описание                                                                 |
|------------|--------------|--------------------------------------------------------------------------|
| `name`     | Нет          | Уникальное имя маршрута (для логирования и отладки)                      |
| `regexp`   | Нет          | Регулярное выражение для сопоставления с URI запроса                     |
| `method`   | Нет          | HTTP-метод (GET, POST, PUT, DELETE и т.д.). Если не указан — любой метод |
| `protocol` | Нет          | Протокол (HTTP, HTTPS). Если не указан — любой протокол                  |

Атрибуты `method` и `protocol` можно перечислять через `|`, например: `method=POST|PUT|PATCH`.

### Вложенность маршрутов

Маршруты могут быть вложенными для создания иерархической структуры:

```xml
<path name="php" regexp="\.php(\?|$)">
    <handler type="forward" to="http://localhost:8000" />

    <path name="phpinfo" regexp="^/phpinfo\.php">
        <handler type="redirect" to="/info.php" code="301" />
    </path>
</path>
```

**Логика обработки:**
1. Сначала проверяется внешний маршрут (`php`)
2. Если он совпал, проверяются вложенные маршруты (`phpinfo`)
3. Если вложенный маршрут совпал, используется его обработчик
4. Если нет — используется обработчик родительского маршрута

## Обработчики — элемент `<handler>`

Обработчики определяют, что делать с запросом, попавшим в маршрут.

### `type="file"` — отдача статических файлов

Возвращает файл из файловой системы. Является обработчиком по умолчанию, если не указан другой.
Поиск файла идет относительно пути, указанного в директиве `<webroot>`.

```xml
<handler type="file" />
```

### `type="redirect"` — HTTP-редирект

Перенаправляет клиента на другой URL.

```xml
<handler type="redirect" to="https://example.com/new-location" code="301" />
```

**Атрибуты:**

| Атрибут    | Обязательный | Описание                                                         |
|------------|--------------|------------------------------------------------------------------|
| `name`     | Нет          | Уникальное имя обработчика (для логирования и отладки)           |
| `to`       | Да           | URL для перенаправления. Может быть абсолютным или относительным |
| `code`     | Нет          | HTTP-код редиректа (301, 302, 307, 308). По умолчанию 302        |

**Коды редиректов:**
- `301` — постоянный редирект (Moved Permanently)
- `302` — временный редирект (Found)
- `307` — временный редирект с сохранением метода
- `308` — постоянный редирект с сохранением метода

### `type="forward"` — проксирование запросов

Перенаправляет запрос на другой HTTP-сервер (reverse proxy).

```xml
<handler type="forward" to="http://localhost:8000" />
```

**Атрибуты:**

| Атрибут    | Обязательный | Описание                                                         |
|------------|--------------|------------------------------------------------------------------|
| `name`     | Нет          | Уникальное имя обработчика (для логирования и отладки)           |
| `to`       | Да           | URL для перенаправления. Может быть абсолютным или относительным |

## Порядок обработки запросов

1. Сервер получает HTTP-запрос
2. Последовательно проверяются все `<path>` элементы верхнего уровня
3. Если `regexp` совпадает с URI:
    - Проверяются `method` и `protocol` (если указаны)
    - Если есть вложенные `<path>`, проверяются они
    - Если найден подходящий `<handler>`, запрос обрабатывается им
4. Если ни один маршрут не подошел, возвращается статический файл из `<webroot>`
5. Если файл не найден, возвращается ошибка 404

## Советы по настройке

### Регулярные выражения

- Используйте `(\?|$)` в конце для учета query string: `\.php(\?|$)`
- Используйте `^` для якоря начала строки: `^/api/`
- Экранируйте спецсимволы: `\.` вместо `.`

### Производительность

- Размещайте более специфичные маршруты выше в конфигурации
- Используйте простые регулярные выражения для частых запросов
- Избегайте излишней вложенности

### Безопасность

- Не размещайте конфигурационные файлы в `<webroot>`
- Используйте абсолютные пути для критичных директорий
- Проверяйте регулярные выражения на корректность

## Отладка конфигурации

Для отладки используйте уровень логирования `debug`:

```bash
php server.php --log-level=debug
```

В логах будут видны:
- Какие маршруты проверяются
- Какой маршрут сработал
- Какой обработчик был вызван
